# Makefile for aarch64-asm Docker Playground
# IMAGE_NAME: Name of the Docker image to build and run
IMAGE_NAME := aarch64-asm
# PLAYGROUND_NAME: Name of the Docker container instance
PLAYGROUND_NAME := arm64-playground

# Build the Docker image with the specified IMAGE_NAME
build:
	@echo "Building Docker image: $(IMAGE_NAME)"
	docker build -t $(IMAGE_NAME) .

# Start the Colima VM, ensure the Docker image exists, and run the container if not already running
start:
	@echo "Checking if Colima VM is running..."
	@if [ "$$(colima status 2>/dev/null)" = "RUNNING" ]; then \
		echo "Colima is already running."; \
	else \
		echo "Starting Colima..."; \
		colima start; \
	fi
	@echo "Checking if Docker image '$(IMAGE_NAME)' exists or needs to be built..."
	$(MAKE) check-image
	$(MAKE) run-container

# Run the Docker container if not already running
run-container:
	@echo "Checking if Docker container '$(PLAYGROUND_NAME)' is already running..."
	@if docker ps --format '{{.Names}}' | grep -wq $(PLAYGROUND_NAME); then \
		echo "Docker container '$(PLAYGROUND_NAME)' is already running. Skipping run."; \
	else \
		echo "Running Docker container '$(PLAYGROUND_NAME)' from image '$(IMAGE_NAME)'..."; \
		docker run -it \
			-v ~/aarch64-asm-docker-ws:/work \
			--name $(PLAYGROUND_NAME) \
			$(IMAGE_NAME); \
	fi

# Check if the Docker image exists; build it if not
check-image:
	@if ! docker image inspect $(IMAGE_NAME) > /dev/null 2>&1; then \
		echo "Docker image '$(IMAGE_NAME)' not found. Building..."; \
		$(MAKE) build; \
	else \
		echo "Docker image '$(IMAGE_NAME)' already exists. Skipping build."; \
	fi


# Remove the running container
clean-docker:
    @echo "Removing Docker container '$(PLAYGROUND_NAME)' (if exists)..."
    docker rm -f $(PLAYGROUND_NAME) || true

# Delete the Colima VM
clean-colima:
    @echo "Deleting Colima VM..."
    colima delete

# Clean both: remove container and delete Colima VM
clean: clean-docker clean-colima

# Assemble and link aarch64 assembly files using cross tools
misc:
	@echo "Assembling hello.s to hello.o..."
	aarch64-linux-gnu-as -o hello.o hello.s
	@echo "Linking hello.o to hello..."
	aarch64-linux-gnu-ld -o hello hello.o
